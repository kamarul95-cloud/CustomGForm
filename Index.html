<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WhatsApp-Style Full Form — Media Caption Fix + Typing</title>
<style>
:root{--bg:#e5ddd5;--user:#DCF8C6;--bot:#fff;--muted:#6b6b6b;--accent:#25D366;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--bg);display:flex;justify-content:center;align-items:flex-start;height:100vh}
.wrap{width:100%;max-width:420px;background:#f9f9f9;border-radius:12px;display:flex;flex-direction:column;height:90vh;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,0.12)}
.header{padding:12px;background:linear-gradient(90deg,#128C7E,var(--accent));color:#fff;font-weight:700;text-align:center}
.chat{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}
.bubble{max-width:78%;padding:10px 14px;border-radius:12px;position:relative;line-height:1.45;word-break:break-word}
.bot{align-self:flex-start;background:var(--bot)}
.user{align-self:flex-end;background:var(--user)}
.time{font-size:11px;color:var(--muted);text-align:right;margin-top:6px}
.inputbar{display:flex;padding:10px;background:#fff;gap:8px;align-items:center;border-top:1px solid rgba(0,0,0,0.04)}
input[type=text], textarea, input[type=date], input[type=time], input[type=number]{flex:1;padding:10px;border-radius:18px;border:1px solid #e6e6e6;font-size:14px}
button.send{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer;min-width:84px;box-shadow:0 6px 12px rgba(37,211,102,0.12)}
.media-wrap{border:1px solid #eee;border-radius:10px;padding:8px;background:#fff;box-shadow:0 4px 10px rgba(0,0,0,0.04)}
.media-wrap img,.media-wrap video,.media-wrap audio,.media-wrap iframe{width:100%;border-radius:8px;margin-top:8px}

/* POLISH STYLES */
.choice-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;justify-content:flex-start}
.choice{flex:1 1 calc(50% - 8px);min-width:120px;max-width:100%;padding:10px 12px;border-radius:18px;border:1px solid #ddd;cursor:pointer;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background:#fff;transition:transform .14s ease, box-shadow .14s ease, background .14s ease;box-shadow: 0 1px 0 rgba(0,0,0,0.03);font-weight:600}
@media (max-width:360px){.choice{flex-basis:100%}}
.choice:hover{transform:translateY(-3px);box-shadow:0 8px 18px rgba(0,0,0,0.06)}
.choice.active, .choice.selected{background:var(--accent);color:#fff;border-color:transparent;box-shadow:0 8px 20px rgba(18,140,126,0.16)}
.mc-grid{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.mc-row{display:flex;gap:8px;overflow:hidden}
.mc-row .choice{flex:1 1 0}
.rating-wrap{display:flex;gap:8px;align-items:center;margin-top:6px}
.rating-wrap .choice{flex:0 0 auto;min-width:44px;padding:8px 10px;font-size:18px;border-radius:10px}
.choice:focus{outline:3px solid rgba(37,211,102,0.12);outline-offset:3px}
input[type=date], input[type=time]{padding:10px;border-radius:14px;border:1px solid #e0e0e0;background:#fff}
@media (max-width:480px){.wrap{height:94vh}.inputbar{padding:8px}button.send{min-width:64px;padding:8px 10px}}
.media-wrap .label{font-weight:700;color:#333}
.helper{font-size:12px;color:#6b6b6b;background:#fff;padding:8px;border-radius:10px;border:1px solid #f0f0f0;margin-top:6px}

/* interactive wrapper marker (for JS cleanup) */
.interactive-wrapper{margin-top:6px}

/* === TYPING styles (new, minimal) === */
.typing-bubble{align-self:flex-start;background:transparent;border-radius:12px;padding:6px 10px;display:flex;align-items:center}
.typing{display:inline-flex;gap:6px;align-items:center;justify-content:center;padding:6px 10px;border-radius:18px;background:#f0f0f0}
.typing span{width:7px;height:7px;border-radius:50%;background:#9aa0a6;opacity:0.9;transform:translateY(0);animation:typing-bounce 1s infinite ease-in-out}
.typing span:nth-child(2){animation-delay:0.12s}
.typing span:nth-child(3){animation-delay:0.24s}
@keyframes typing-bounce{
  0%{transform:translateY(0);opacity:.3}
  50%{transform:translateY(-6px);opacity:1}
  100%{transform:translateY(0);opacity:.3}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">Form Bot - WhatsApp Style</div>
  <div class="chat" id="chat" aria-live="polite"></div>
  <div class="inputbar" id="inputbar" aria-hidden="false">
    <input type="text" id="input" placeholder="Taip jawapan..." aria-label="Input jawapan"/>
    <button class="send" id="sendBtn">Hantar</button>
  </div>
</div>

<script>
/* === KOD JAVASCRIPT YANG DIUBAHSUAI === */

/* === CONFIG === */
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSF204UTvqeBbWfd9bllNI8dBjvjmuzOnAJ39EOihc0uC22BOm60B-Pkl5jAE5JvM5OVWvBmxMhHWIS/pub?output=csv';

let questions = [], idx = 0, responses = {}, currentAnswer = null;
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const inputbar = document.getElementById('inputbar');
const sendBtn = document.getElementById('sendBtn');

/* === helpers === */
function timeNow(){ const d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function appendBubble(text, cls){
  const e=document.createElement('div'); e.className='bubble '+cls;
  const content=document.createElement('div'); content.textContent = text;
  e.appendChild(content);
  const t=document.createElement('div'); t.className='time'; t.textContent=timeNow();
  e.appendChild(t);
  chat.appendChild(e);
  setTimeout(()=>{ e.scrollIntoView({behavior:'smooth', block:'center'}); }, 30);
  return e;
}
function detectMediaType(url){
  if(!url) return 'unknown';
  const ext = url.split('?')[0].split('.').pop().toLowerCase();
  if(['png','jpg','jpeg','gif','webp'].includes(ext)) return 'image';
  if(['mp4','webm','ogg','mov'].includes(ext)) return 'video';
  if(['mp3','wav','m4a','aac','oga'].includes(ext)) return 'audio';
  if(ext==='pdf') return 'pdf';
  return 'unknown';
}

/* === renderMedia: only show caption if non-empty === */
function renderMedia(url,label=''){
  const wrap=document.createElement('div'); wrap.className='media-wrap';
  // Use a temporary div to render text content and then extract
  const tempDiv = document.createElement('div'); tempDiv.textContent = label;
  const processedLabel = tempDiv.innerHTML.replace(/\(([^)]+)\)/g, (match, key) => responses[key] || match);
  if(processedLabel && processedLabel.trim() !== ''){ const lab=document.createElement('div'); lab.className='label'; lab.innerHTML=processedLabel; wrap.appendChild(lab); }
  
  const type=detectMediaType(url);
  if(type==='image'){ const img=document.createElement('img'); img.src=url; img.alt=label||''; wrap.appendChild(img); }
  else if(type==='video'){ const vid=document.createElement('video'); vid.src=url; vid.controls=true; wrap.appendChild(vid); }
  else if(type==='audio'){ const au=document.createElement('audio'); au.src=url; au.controls=true; wrap.appendChild(au); }
  else if(type==='pdf'){ const iframe=document.createElement('iframe'); iframe.src=url; iframe.style.height='320px'; wrap.appendChild(iframe); }
  else{ const a=document.createElement('a'); a.href=url; a.target='_blank'; a.textContent='Buka / Muat Turun ' + (label || 'Fail'); wrap.appendChild(a); }
  chat.appendChild(wrap);
  setTimeout(()=>{ wrap.scrollIntoView({behavior:'smooth', block:'center'}); }, 30);
}

/* === TYPING UI (minimal safe add) === */
function showTyping(duration = 600){
  return new Promise(resolve => {
    const wrapper = document.createElement('div');
    wrapper.className = 'typing-bubble';
    const t = document.createElement('div');
    t.className = 'typing';
    t.innerHTML = '<span></span><span></span><span></span>';
    wrapper.appendChild(t);
    chat.appendChild(wrapper);
    // scroll into view
    setTimeout(()=>{ wrapper.scrollIntoView({behavior:'smooth', block:'center'}); }, 10);
    setTimeout(()=>{
      wrapper.remove();
      resolve();
    }, duration);
  });
}

/* === cleanup helper (unchanged) === */
function clearInteractiveElements(){
  const wrappers = Array.from(document.querySelectorAll('.interactive-wrapper'));
  wrappers.forEach(w=>w.remove());
  Array.from(document.querySelectorAll('.interactive-wrapper input[type="file"]')).forEach(f=>f.remove());
  input.value = '';
  inputbar.style.display = 'none';
}

/**
 * Renders the input elements for the current question.
 * @param {object} q - The current question object.
 */
function renderInput(q){
  input.value=''; currentAnswer=null;
  inputbar.style.display='flex';
  input.type='text';

  // --- START: Interpolasi Jawapan (Placeholder) ---
  const originalQuestion = q.question || '';
  const processedQuestion = originalQuestion.replace(/\(([^)]+)\)/g, (match, key) => {
      // 'key' should be the question number (e.g., '1' from '(1)')
      // Look up the response using the key
      const responseValue = responses[key];
      // Return the response, or the original placeholder if not found
      return responseValue !== undefined ? responseValue : match;
  });
  
  // Use the processed question for the bubble and input placeholder
  const bubbleText = processedQuestion;
  input.placeholder= processedQuestion;
  // --- END: Interpolasi Jawapan (Placeholder) ---

  if(q.type === 'closing'){
    if(bubbleText && bubbleText.trim()!=='') appendBubble(bubbleText,'bot');
    if(q.closing && q.closing.trim()!=='') appendBubble(q.closing,'bot');
    idx = questions.length;
    clearInteractiveElements();
    console.log('responses', responses);
    return;
  }

  // --- Append Bot Bubble for current question text (after interpolation) ---
  if(q.type !== 'media' && q.type !== 'file' && bubbleText && bubbleText.trim() !== ''){
      appendBubble(bubbleText, 'bot');
  }
  // --- END Append Bot Bubble ---


  if(q.type==='textarea'){
    // Since we appended the bot bubble above, we only need to render the input.
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper';
    const ta = document.createElement('textarea'); ta.placeholder = q.question; ta.rows = 4; ta.style.width='100%';
    const btn = document.createElement('button'); btn.className='send'; btn.textContent='Hantar';
    btn.onclick = ()=>{
      const val = ta.value.trim(); if(!val) return alert('Sila isi jawapan');
      appendBubble(val,'user');
      responses[q.id] = val; // Save response using the ID (the question number)
      clearInteractiveElements();
      idx++;
      nextQuestion();
    };
    wrapper.appendChild(ta); wrapper.appendChild(btn);
    inputbar.after(wrapper);
    return;
  }

  if(q.type==='choice' || q.type==='dropdown'){
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper';
    const grid = document.createElement('div'); grid.className='choice-grid';
    (q.options||[]).forEach(opt=>{
      const b=document.createElement('button'); b.className='choice'; b.textContent=opt;
      b.onclick = ()=>{
        appendBubble(opt,'user');
        responses[q.id] = opt; // Save response using the ID (the question number)
        clearInteractiveElements();
        idx++;
        nextQuestion();
      };
      grid.appendChild(b);
    });
    wrapper.appendChild(grid);
    inputbar.after(wrapper);
    return;
  }

  if(q.type==='checkbox'){
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper';
    const grid = document.createElement('div'); grid.className='choice-grid';
    const selected = [];
    (q.options||[]).forEach(opt=>{
      const b = document.createElement('button'); b.className='choice'; b.textContent=opt;
      b.onclick = ()=>{
        if(selected.includes(opt)){ selected.splice(selected.indexOf(opt),1); b.classList.remove('active'); }
        else { selected.push(opt); b.classList.add('active'); }
      };
      grid.appendChild(b);
    });
    const submitBtn = document.createElement('button'); submitBtn.className='send'; submitBtn.textContent='Hantar';
    submitBtn.onclick = ()=>{
      if(selected.length===0) return alert('Sila pilih sekurang-kurangnya satu!');
      appendBubble(selected.join(', '),'user');
      responses[q.id] = selected.slice().join(', '); // Save as comma-separated string for simpler placeholder
      clearInteractiveElements();
      idx++;
      nextQuestion();
    };
    wrapper.appendChild(grid); wrapper.appendChild(submitBtn);
    inputbar.after(wrapper);
    return;
  }

  if(q.type==='linear_scale' || q.type==='rating'){
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper';
    const grid = document.createElement('div'); grid.className='choice-grid rating-wrap';
    const max = q.max || 5;
    for(let i=1;i<=max;i++){
      const b = document.createElement('button'); b.className='choice'; b.textContent = i;
      b.onclick = ()=>{
        const val = String(i);
        appendBubble(val,'user');
        responses[q.id] = val; // Save response using the ID (the question number)
        clearInteractiveElements();
        idx++;
        nextQuestion();
      };
      grid.appendChild(b);
    }
    wrapper.appendChild(grid);
    inputbar.after(wrapper);
    return;
  }

  if(q.type==='multiple_choice_grid' || q.type==='checkbox_grid'){
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper mc-grid';
    const gridResponses = [];
    
    if(q.type==='checkbox_grid'){
      // Simplified: only allow one choice per group/row for easy placeholder (as per choice grid)
      const joined = (Array.isArray(q.options) ? q.options.join(';') : (q.options||'')).toString();
      const parts = joined.split(/\s*;\s*/).filter(Boolean);
      const groups = {};
      parts.forEach(p=>{
        if(p.includes(':')){
          const [k,rest] = p.split(':'); 
          const items = (rest||'').split(',').map(s=>s.trim()).filter(Boolean);
          groups[k.trim()] = (groups[k.trim()]||[]).concat(items);
        } else {
          groups['Pilihan'] = groups['Pilihan'] || []; groups['Pilihan'].push(p.trim());
        }
      });
      
      const selectionMap = {};
      
      Object.keys(groups).forEach(k=>{
        const label = document.createElement('div'); label.className='helper'; label.textContent = k;
        const rowWrap = document.createElement('div'); rowWrap.className='mc-row';
        groups[k].forEach(opt=>{
          const btn = document.createElement('button'); btn.className='choice'; btn.textContent = opt;
          btn.onclick = ()=>{
            // Update UI for single selection in this group
            Array.from(rowWrap.querySelectorAll('.choice')).forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            selectionMap[k] = opt; // Store the selection
            
            // Generate response array for the user bubble and final response
            const finalResponse = Object.keys(selectionMap).map(key => `${key}: ${selectionMap[key]}`);
            
            appendBubble(finalResponse.join(', '),'user');
            responses[q.id] = finalResponse.join(', '); // Save as string
            clearInteractiveElements();
            idx++;
            nextQuestion();
          };
          rowWrap.appendChild(btn);
        });
        wrapper.appendChild(label); wrapper.appendChild(rowWrap);
      });
      // NOTE: For Checkbox Grid, the submit button approach is more complex for placeholder, 
      // so this example keeps the simplified "click one to submit" logic.
      
    } else { // Multiple Choice Grid (Single selection)
      (q.options||[]).forEach(opt=>{
        const row = document.createElement('div'); row.className='mc-row';
        const btn = document.createElement('button'); btn.className='choice'; btn.textContent = opt;
        btn.onclick = ()=>{
          appendBubble(opt,'user');
          responses[q.id] = opt; // Save response using the ID (the question number)
          clearInteractiveElements();
          idx++;
          nextQuestion();
        };
        row.appendChild(btn);
        wrapper.appendChild(row);
      });
    }
    inputbar.after(wrapper);
    return;
  }

  // FILE: admin-file vs user-upload
  if(q.type==='file'){
    if(q.url){
      // use caption (if any) — admin provided file preview (persistent)
      renderMedia(q.url, q.caption || ''); // renderMedia handles caption interpolation now
      idx++;
      setTimeout(()=>nextQuestion(), 420);
      return;
    }
    // user-upload logic
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper';
    const help = document.createElement('div'); help.className='helper'; help.textContent='Klik "Pilih Fail" untuk buka picker (Gallery/Files).';
    const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.accept='*/*';
    const submitBtn = document.createElement('button'); submitBtn.className='send'; submitBtn.textContent='Hantar';
    submitBtn.onclick = ()=>{
      const f = fileInput.files[0]; if(!f) return alert('Sila pilih fail');
      appendBubble(f.name,'user');
      responses[q.id] = f.name; // Save filename for placeholder
      renderMedia(URL.createObjectURL(f), f.name);
      clearInteractiveElements();
      idx++;
      nextQuestion();
    };
    wrapper.appendChild(help); wrapper.appendChild(fileInput); wrapper.appendChild(submitBtn);
    inputbar.after(wrapper);
    return;
  }

  // MEDIA: admin media persistent (use caption not question)
  if(q.type==='media'){
    if(q.url){
      // Only render media with interpolation, and then immediately move to next question
      renderMedia(q.url, q.caption || ''); // renderMedia handles caption interpolation now
      idx++;
      setTimeout(()=>nextQuestion(), 420);
      return;
    } else {
      idx++;
      setTimeout(()=>nextQuestion(), 60);
      return;
    }
  }

  if(q.type==='date' || q.type==='time' || q.type==='number'){
    inputbar.style.display='flex';
    input.type = q.type;
    return;
  }

  // Fallback for TEXT type
  input.type = 'text';
}

/* === progression & send handler === */
/* nextQuestion made async to allow awaiting showTyping (minimal change) */
async function nextQuestion(){
  if(idx >= questions.length){
    console.log('responses', responses);
    clearInteractiveElements();
    return;
  }
  const q = questions[idx];
  
  // 1. Show typing animation
  await showTyping(600); 

  // 2. Render input/question structure. 
  // NOTE: The new logic for TEXT/DATE/TIME/NUMBER will append the bot bubble INSIDE renderInput() 
  // after interpolating the placeholder. Media/File/Closing will handle their own.
  setTimeout(()=>renderInput(q), 260);
}

sendBtn.onclick = ()=>{
  if(!currentAnswer) currentAnswer = input.value.trim();
  if(!currentAnswer) return alert('Sila isi jawapan!');
  appendBubble(currentAnswer,'user');
  
  // --- START: Simpan jawapan guna ID (nombor soalan) sebagai kunci ---
  const currentQid = questions[idx].id;
  responses[currentQid] = currentAnswer;
  // --- END: Simpan jawapan guna ID (nombor soalan) sebagai kunci ---
  
  clearInteractiveElements();
  currentAnswer = null; input.value = '';
  idx++;
  nextQuestion();
};

/* === robust CSV fetch & parse (Minimal changes to ensure 'id' is a string of the question number) === */
fetch(SHEET_CSV_URL).then(r=>r.text()).then(txt=>{
  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) throw new Error('CSV kosong atau tak dapat diakses');
  const header = lines[0].split(',').map(h=>h.trim().toLowerCase());
  const rows = lines.slice(1).map(l=>{
    if(l.indexOf('"') !== -1){
      const vals=[]; let cur='', inQuotes=false;
      for(let i=0;i<l.length;i++){
        const ch = l[i], nxt = l[i+1];
        if(ch === '"'){ if(inQuotes && nxt === '"'){ cur+='"'; i++; continue; } inQuotes = !inQuotes; continue; }
        if(ch === ',' && !inQuotes){ vals.push(cur); cur=''; continue; }
        cur += ch;
      }
      vals.push(cur); return vals;
    }
    return l.split(',').map(c=>c.trim());
  });

  // header indexes
  const iNo = header.indexOf('no');
  const iType = header.indexOf('type');
  const iQ = header.indexOf('question / label') !== -1 ? header.indexOf('question / label') : header.indexOf('question');
  const iOpt = header.indexOf('options');
  const iFile = header.indexOf('file_url');
  const iClosing = header.indexOf('closing_template');
  const iCaption = header.indexOf('media_caption');

  questions = rows.map(r=>{
    const obj = {};
    // --- START: Pastikan ID adalah nombor soalan sebagai STRING ---
    const questionNumber = (r[iNo]||'').toString().trim();
    obj.id = questionNumber || ('q'+Math.random().toString(36).slice(2,6));
    // --- END: Pastikan ID adalah nombor soalan sebagai STRING ---

    obj.type = (r[iType]||'text').toString().trim();

    const rawQ = (r[iQ]||'').toString().trim();

    if(obj.type === 'media' || (obj.type === 'file' && r[iFile])){
      obj.question = rawQ; 
    } else {
      obj.question = rawQ || (`Soalan ${questionNumber} (${obj.id})`);
    }

    if(r[iClosing]) obj.closing = (r[iClosing]||'').toString().trim();
    if(['choice','dropdown','checkbox','multiple_choice_grid','checkbox_grid'].includes(obj.type) && r[iOpt]){
      obj.options = (r[iOpt]||'').toString().split(';').map(s=>s.trim()).filter(Boolean);
    }
    if(obj.type==='linear_scale' || obj.type==='rating'){
      obj.max = parseInt((r[iOpt]||'').toString()) || 5;
    }
    // save url and caption if present
    if((obj.type==='file' || obj.type==='media') && r[iFile]){
      obj.url = (r[iFile]||'').toString().trim();
      obj.caption = (iCaption !== -1 && r[iCaption]) ? r[iCaption].toString().trim() : '';
    }
    return obj;
  });

  // start conversation AFTER questions built
  nextQuestion();
}).catch(e=>{
  appendBubble('❌ Gagal muatkan soalan: '+(e.message||e),'bot');
});
</script>
</body>
</html>
