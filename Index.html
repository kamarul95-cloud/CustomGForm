<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WhatsApp-Style Full Form — Admin Media Persist</title>
<style>
:root{--bg:#e5ddd5;--user:#DCF8C6;--bot:#fff;--muted:#6b6b6b;--accent:#25D366;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--bg);display:flex;justify-content:center;align-items:flex-start;height:100vh}
.wrap{width:100%;max-width:420px;background:#f9f9f9;border-radius:12px;display:flex;flex-direction:column;height:90vh;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,0.12)}
.header{padding:12px;background:linear-gradient(90deg,#128C7E,var(--accent));color:#fff;font-weight:700;text-align:center}
.chat{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}
.bubble{max-width:78%;padding:10px 14px;border-radius:12px;position:relative;line-height:1.45;word-break:break-word}
.bot{align-self:flex-start;background:var(--bot)}
.user{align-self:flex-end;background:var(--user)}
.time{font-size:11px;color:var(--muted);text-align:right;margin-top:6px}
.inputbar{display:flex;padding:10px;background:#fff;gap:8px;align-items:center;border-top:1px solid rgba(0,0,0,0.04)}
input[type=text], textarea, input[type=date], input[type=time], input[type=number]{flex:1;padding:10px;border-radius:18px;border:1px solid #e6e6e6;font-size:14px}
button.send{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer;min-width:84px;box-shadow:0 6px 12px rgba(37,211,102,0.12)}
.media-wrap{border:1px solid #eee;border-radius:10px;padding:8px;background:#fff;box-shadow:0 4px 10px rgba(0,0,0,0.04)}
.media-wrap img,.media-wrap video,.media-wrap audio,.media-wrap iframe{width:100%;border-radius:8px;margin-top:8px}

/* POLISH STYLES */
.choice-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;justify-content:flex-start}
.choice{flex:1 1 calc(50% - 8px);min-width:120px;max-width:100%;padding:10px 12px;border-radius:18px;border:1px solid #ddd;cursor:pointer;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background:#fff;transition:transform .14s ease, box-shadow .14s ease, background .14s ease;box-shadow: 0 1px 0 rgba(0,0,0,0.03);font-weight:600}
@media (max-width:360px){.choice{flex-basis:100%}}
.choice:hover{transform:translateY(-3px);box-shadow:0 8px 18px rgba(0,0,0,0.06)}
.choice.active, .choice.selected{background:var(--accent);color:#fff;border-color:transparent;box-shadow:0 8px 20px rgba(18,140,126,0.16)}
.mc-grid{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.mc-row{display:flex;gap:8px;overflow:hidden}
.mc-row .choice{flex:1 1 0}
.rating-wrap{display:flex;gap:8px;align-items:center;margin-top:6px}
.rating-wrap .choice{flex:0 0 auto;min-width:44px;padding:8px 10px;font-size:18px;border-radius:10px}
.choice:focus{outline:3px solid rgba(37,211,102,0.12);outline-offset:3px}
input[type=date], input[type=time]{padding:10px;border-radius:14px;border:1px solid #e0e0e0;background:#fff}
@media (max-width:480px){.wrap{height:94vh}.inputbar{padding:8px}button.send{min-width:64px;padding:8px 10px}}
.media-wrap .label{font-weight:700;color:#333}
.helper{font-size:12px;color:#6b6b6b;background:#fff;padding:8px;border-radius:10px;border:1px solid #f0f0f0;margin-top:6px}

/* interactive wrapper marker (for JS cleanup) */
.interactive-wrapper{margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">Form Bot - WhatsApp Style</div>
  <div class="chat" id="chat" aria-live="polite"></div>
  <div class="inputbar" id="inputbar" aria-hidden="false">
    <input type="text" id="input" placeholder="Taip jawapan..." aria-label="Input jawapan"/>
    <button class="send" id="sendBtn">Hantar</button>
  </div>
</div>

<script>
/* === CONFIG === */
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSF204UTvqeBbWfd9bllNI8dBjvjmuzOnAJ39EOihc0uC22BOm60B-Pkl5jAE5JvM5OVWvBmxMhHWIS/pub?output=csv';

let questions = [], idx = 0, responses = {}, currentAnswer = null;
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const inputbar = document.getElementById('inputbar');
const sendBtn = document.getElementById('sendBtn');

/* === helpers === */
function timeNow(){ const d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function appendBubble(text, cls){
  const e=document.createElement('div'); e.className='bubble '+cls;
  const content=document.createElement('div'); content.textContent = text;
  e.appendChild(content);
  const t=document.createElement('div'); t.className='time'; t.textContent=timeNow();
  e.appendChild(t);
  chat.appendChild(e);
  setTimeout(()=>{ e.scrollIntoView({behavior:'smooth', block:'center'}); }, 30);
  return e;
}
function detectMediaType(url){
  if(!url) return 'unknown';
  const ext = url.split('?')[0].split('.').pop().toLowerCase();
  if(['png','jpg','jpeg','gif','webp'].includes(ext)) return 'image';
  if(['mp4','webm','ogg','mov'].includes(ext)) return 'video';
  if(['mp3','wav','m4a','aac','oga'].includes(ext)) return 'audio';
  if(ext==='pdf') return 'pdf';
  return 'unknown';
}
function renderMedia(url,label='Media'){
  const wrap=document.createElement('div'); wrap.className='media-wrap';
  if(label){ const lab=document.createElement('div'); lab.className='label'; lab.textContent=label; wrap.appendChild(lab); }
  const type=detectMediaType(url);
  if(type==='image'){ const img=document.createElement('img'); img.src=url; img.alt=label; wrap.appendChild(img); }
  else if(type==='video'){ const vid=document.createElement('video'); vid.src=url; vid.controls=true; wrap.appendChild(vid); }
  else if(type==='audio'){ const au=document.createElement('audio'); au.src=url; au.controls=true; wrap.appendChild(au); }
  else if(type==='pdf'){ const iframe=document.createElement('iframe'); iframe.src=url; iframe.style.height='320px'; wrap.appendChild(iframe); }
  else{ const a=document.createElement('a'); a.href=url; a.target='_blank'; a.textContent='Buka / Muat Turun '+label; wrap.appendChild(a); }
  chat.appendChild(wrap);
  setTimeout(()=>{ wrap.scrollIntoView({behavior:'smooth', block:'center'}); }, 30);
}

/* === cleanup helper (removes interactive elements only) === */
function clearInteractiveElements(){
  // remove any element we created with class interactive-wrapper
  const wrappers = Array.from(document.querySelectorAll('.interactive-wrapper'));
  wrappers.forEach(w=>w.remove());
  // remove transient file inputs created inside wrappers (if any left)
  Array.from(document.querySelectorAll('.interactive-wrapper input[type="file"]')).forEach(f=>f.remove());
  // reset input box and hide inputbar; persistent media (media-wrap) are NOT removed
  input.value = '';
  inputbar.style.display = 'none';
}

/* === renderInput === */
function renderInput(q){
  input.value=''; currentAnswer=null;
  inputbar.style.display='flex';
  input.type='text';
  input.placeholder=q.question || '';

  // CLOSING: show and auto-advance so items after closing (including media) show
  if(q.type === 'closing'){
    appendBubble(q.question || '—','bot');
    if(q.closing) appendBubble(q.closing,'bot');
    // no interactive elements to clear for closing; advance to next item
    idx++;
    setTimeout(()=>nextQuestion(), 260);
    return;
  }

  // TEXTAREA
  if(q.type==='textarea'){
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper';
    const ta = document.createElement('textarea'); ta.placeholder = q.question; ta.rows = 4; ta.style.width='100%';
    const btn = document.createElement('button'); btn.className='send'; btn.textContent='Hantar';
    btn.onclick = ()=>{
      const val = ta.value.trim(); if(!val) return alert('Sila isi jawapan');
      appendBubble(val,'user');
      responses[q.id] = val;
      clearInteractiveElements();
      idx++;
      nextQuestion();
    };
    wrapper.appendChild(ta); wrapper.appendChild(btn);
    inputbar.after(wrapper);
    return;
  }

  // CHOICE / DROPDOWN
  if(q.type==='choice' || q.type==='dropdown'){
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper';
    const grid = document.createElement('div'); grid.className='choice-grid';
    (q.options||[]).forEach(opt=>{
      const b=document.createElement('button'); b.className='choice'; b.textContent=opt;
      b.onclick = ()=>{
        appendBubble(opt,'user');
        responses[q.id] = opt;
        clearInteractiveElements();
        idx++;
        nextQuestion();
      };
      grid.appendChild(b);
    });
    wrapper.appendChild(grid);
    inputbar.after(wrapper);
    return;
  }

  // CHECKBOX
  if(q.type==='checkbox'){
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper';
    const grid = document.createElement('div'); grid.className='choice-grid';
    const selected = [];
    (q.options||[]).forEach(opt=>{
      const b = document.createElement('button'); b.className='choice'; b.textContent=opt;
      b.onclick = ()=>{
        if(selected.includes(opt)){ selected.splice(selected.indexOf(opt),1); b.classList.remove('active'); }
        else { selected.push(opt); b.classList.add('active'); }
      };
      grid.appendChild(b);
    });
    const submitBtn = document.createElement('button'); submitBtn.className='send'; submitBtn.textContent='Hantar';
    submitBtn.onclick = ()=>{
      if(selected.length===0) return alert('Sila pilih sekurang-kurangnya satu!');
      appendBubble(selected.join(', '),'user');
      responses[q.id] = selected.slice();
      clearInteractiveElements();
      idx++;
      nextQuestion();
    };
    wrapper.appendChild(grid); wrapper.appendChild(submitBtn);
    inputbar.after(wrapper);
    return;
  }

  // LINEAR SCALE (rating)
  if(q.type==='linear_scale' || q.type==='rating'){
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper';
    const grid = document.createElement('div'); grid.className='choice-grid rating-wrap';
    const max = q.max || 5;
    for(let i=1;i<=max;i++){
      const b = document.createElement('button'); b.className='choice'; b.textContent = i;
      b.onclick = ()=>{
        appendBubble(String(i),'user');
        responses[q.id] = i;
        clearInteractiveElements();
        idx++;
        nextQuestion();
      };
      grid.appendChild(b);
    }
    wrapper.appendChild(grid);
    inputbar.after(wrapper);
    return;
  }

  // MULTIPLE CHOICE GRID / CHECKBOX GRID
  if(q.type==='multiple_choice_grid' || q.type==='checkbox_grid'){
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper mc-grid';
    if(q.type==='checkbox_grid'){
      const joined = (Array.isArray(q.options) ? q.options.join(';') : (q.options||'')).toString();
      const parts = joined.split(/\s*;\s*/).filter(Boolean);
      const groups = {};
      parts.forEach(p=>{
        if(p.includes(':')){
          const [k,rest] = p.split(':'); 
          const items = (rest||'').split(',').map(s=>s.trim()).filter(Boolean);
          groups[k.trim()] = (groups[k.trim()]||[]).concat(items);
        } else {
          groups['Pilihan'] = groups['Pilihan'] || []; groups['Pilihan'].push(p.trim());
        }
      });
      Object.keys(groups).forEach(k=>{
        const label = document.createElement('div'); label.className='helper'; label.textContent = k;
        const rowWrap = document.createElement('div'); rowWrap.className='mc-row';
        groups[k].forEach(opt=>{
          const btn = document.createElement('button'); btn.className='choice'; btn.textContent = opt;
          btn.onclick = ()=>{
            appendBubble(`${k}: ${opt}`,'user');
            responses[q.id] = responses[q.id] || []; responses[q.id].push(`${k}: ${opt}`);
            clearInteractiveElements();
            idx++;
            nextQuestion();
          };
          rowWrap.appendChild(btn);
        });
        wrapper.appendChild(label); wrapper.appendChild(rowWrap);
      });
    } else {
      (q.options||[]).forEach(opt=>{
        const row = document.createElement('div'); row.className='mc-row';
        const btn = document.createElement('button'); btn.className='choice'; btn.textContent = opt;
        btn.onclick = ()=>{
          appendBubble(opt,'user');
          responses[q.id] = opt;
          clearInteractiveElements();
          idx++;
          nextQuestion();
        };
        row.appendChild(btn);
        wrapper.appendChild(row);
      });
    }
    inputbar.after(wrapper);
    return;
  }

  // FILE: if admin-provided URL exists -> show admin media persistently; else show upload UI
  if(q.type==='file'){
    if(q.url){
      // admin file: render persistently (not inside interactive wrapper)
      renderMedia(q.url, q.question);
      // advance
      idx++;
      setTimeout(()=>nextQuestion(), 420);
      return;
    }
    // else user upload case
    inputbar.style.display='none';
    const wrapper = document.createElement('div'); wrapper.className='interactive-wrapper';
    const help = document.createElement('div'); help.className='helper'; help.textContent='Klik "Pilih Fail" untuk buka picker (Gallery/Files).';
    const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.accept='*/*';
    const submitBtn = document.createElement('button'); submitBtn.className='send'; submitBtn.textContent='Hantar';
    submitBtn.onclick = ()=>{
      const f = fileInput.files[0]; if(!f) return alert('Sila pilih fail');
      appendBubble(f.name,'user');
      responses[q.id] = f.name;
      renderMedia(URL.createObjectURL(f), f.name);
      clearInteractiveElements();
      idx++;
      nextQuestion();
    };
    wrapper.appendChild(help); wrapper.appendChild(fileInput); wrapper.appendChild(submitBtn);
    inputbar.after(wrapper);
    return;
  }

  // MEDIA: admin media persistent (render and advance)
  if(q.type==='media'){
    if(q.url){
      renderMedia(q.url, q.question);
      idx++;
      setTimeout(()=>nextQuestion(), 420);
      return;
    } else {
      // no url -> nothing to show, just advance
      idx++;
      setTimeout(()=>nextQuestion(), 60);
      return;
    }
  }

  // DATE / TIME
  if(q.type==='date' || q.type==='time'){
    inputbar.style.display='flex';
    input.type = q.type;
    input.placeholder = q.question;
    return;
  }

  // fallback text input
  input.type = 'text';
  input.placeholder = q.question;
}

/* === progression & send handler === */
function nextQuestion(){
  if(idx >= questions.length){
    appendBubble('Terima kasih! Semua soalan dijawab.','bot');
    console.log('responses', responses);
    clearInteractiveElements();
    return;
  }
  const q = questions[idx];
  appendBubble(q.question,'bot');
  setTimeout(()=>renderInput(q), 260);
}

sendBtn.onclick = ()=>{
  if(!currentAnswer) currentAnswer = input.value.trim();
  if(!currentAnswer) return alert('Sila isi jawapan!');
  appendBubble(currentAnswer,'user');
  responses[questions[idx].id] = currentAnswer;
  clearInteractiveElements();
  currentAnswer = null; input.value = '';
  idx++;
  nextQuestion();
};

/* === robust CSV fetch & parse === */
fetch(SHEET_CSV_URL).then(r=>r.text()).then(txt=>{
  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) throw new Error('CSV kosong atau tak dapat diakses');
  const header = lines[0].split(',').map(h=>h.trim().toLowerCase());
  const rows = lines.slice(1).map(l=>{
    if(l.indexOf('"') !== -1){
      const vals=[]; let cur='', inQuotes=false;
      for(let i=0;i<l.length;i++){
        const ch = l[i], nxt = l[i+1];
        if(ch === '"'){ if(inQuotes && nxt === '"'){ cur+='"'; i++; continue; } inQuotes = !inQuotes; continue; }
        if(ch === ',' && !inQuotes){ vals.push(cur); cur=''; continue; }
        cur += ch;
      }
      vals.push(cur); return vals;
    }
    return l.split(',').map(c=>c.trim());
  });

  const iNo = header.indexOf('no');
  const iType = header.indexOf('type');
  const iQ = header.indexOf('question / label') !== -1 ? header.indexOf('question / label') : header.indexOf('question');
  const iOpt = header.indexOf('options');
  const iFile = header.indexOf('file_url');
  const iClosing = header.indexOf('closing_template');

  questions = rows.map(r=>{
    const obj = {};
    obj.id = (r[iNo]||'').toString().trim() || ('q'+Math.random().toString(36).slice(2,6));
    obj.type = (r[iType]||'text').toString().trim();
    obj.question = (r[iQ]||'').toString().trim() || ('Soalan '+obj.id);
    if(r[iClosing]) obj.closing = (r[iClosing]||'').toString().trim();
    if(['choice','dropdown','checkbox','multiple_choice_grid','checkbox_grid'].includes(obj.type) && r[iOpt]){
      obj.options = (r[iOpt]||'').toString().split(';').map(s=>s.trim()).filter(Boolean);
    }
    if(obj.type==='linear_scale' || obj.type==='rating'){
      obj.max = parseInt((r[iOpt]||'').toString()) || 5;
    }
    // Mark admin media/file if file_url present
    if((obj.type==='file' || obj.type==='media') && r[iFile]){
      obj.url = (r[iFile]||'').toString().trim();
    }
    return obj;
  });

  nextQuestion();
}).catch(e=>{
  appendBubble('❌ Gagal muatkan soalan: '+(e.message||e),'bot');
});
</script>
</body>
</html>
